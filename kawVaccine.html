<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>شركة ركن الحطيم للحج - رفع ملف التطعيمات PDF</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    * {
      font-family: 'Cairo', sans-serif;
    }
    body {
      background: #f0f2f5;
      direction: rtl;
      padding: 30px;
      max-width: 700px;
      margin: auto;
      text-align: right;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .form-box {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #198754;
      color: white;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #157347;
    }
    #loader {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .support-box {
      background: #fff;
      padding: 20px;
      border-top: 1px solid #ccc;
      border-radius: 0 0 10px 10px;
      text-align: center;
      font-size: 15px;
    }
    .support-box a {
      display: inline-block;
      padding: 10px 20px;
      background: #25D366;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="header">
  <img src="logo.png" alt="شعار الشركة" style="height: 80px; margin-bottom: 10px;">
  <h2 style="color: #198754;">شركة ركن الحطيم للحج</h2>
  <p>نموذج  رفع ملف التطعيمات - حج   1446هـ</p>
</div>

<div class="form-box" id="verifyBox">
  <h3>التحقق من رقم الجوال</h3>
  <label>رقم الجوال:</label>
  <input type="tel" id="phoneSearch" maxlength="10" inputmode="numeric">
  <button onclick="checkData()">التالي</button>
  <div id="loader">جاري التحقق...</div>
</div>

<div class="form-box" id="formBox" style="display:none;">
  <h3>بيانات الكادر</h3>

  <label>رقم الهوية:</label>
  <input type="text" id="id" readonly style="background:#eee;">

  <label>الاسم الكامل:</label>
  <input type="text" id="full_name" readonly style="background:#eee;">

  
    
    <label class="required">القسم:</label>
    <select id="department" class="form-control" style="margin-bottom: 15px;" required>
      <option value="">اختر القسم</option>
      <option value="الشركة">الشركة</option>
      <option value="العمران">العمران</option>
      <option value="المبرز">المبرز</option>
      <option value="الشعبة">الشعبة</option>
    </select>
    <label class="required">تاريخ الميلاد (ميلادي فقط):</label>
    
  <input type="date" id="birth_date_en" required>

  <label>ملف التطعيمات (PDF):</label>
  <input type="file" id="pdfFile" accept="application/pdf">

  <div id="submitLoader" style="display:none; text-align:center; margin-top:15px;">
    <img src="https://i.imgur.com/llF5iyg.gif" alt="جاري الإرسال" width="40"><br>
    جاري إرسال البيانات...
  </div>

  
  <button onclick="submitData()">إرسال البيانات</button>
</div>


<div class="support-box">
  <p>عند مواجهتك أي مشكلة في تعبئة النموذج، يمكنك التواصل مع الدعم الفني الخاص بشركة ركن الحطيم عبر واتساب:</p>
  <a href="https://wa.me/966539617330" target="_blank">التواصل عبر واتساب</a>
</div>

<script>
  // Firestore الأساسي
  const primaryApp = firebase.initializeApp({
    apiKey: "AIzaSyCjLt3g-2GPsMlxXPnzySXpCHl3-FyA80I",
    authDomain: "hajj2025-56177.firebaseapp.com",
    projectId: "hajj2025-56177"
  }, "Primary");

  const db = firebase.firestore(primaryApp);

  // التخزين في مشروع خارجي
  const storageApp = firebase.initializeApp({
    apiKey: "AIzaSyDHNEidF1ShWR7KDSN2GW34Qf6-s6ISvZQ",
    authDomain: "hajj2025-2.firebaseapp.com",
    projectId: "hajj2025-2",
    storageBucket: "hajj2025-2.appspot.com"
  }, "Storage");

  const storage = firebase.storage(storageApp);

  let currentPhone = "";
  let currentId = "";

  
    async function checkData() {
      const input = document.getElementById("phoneSearch").value.trim();
      if (!input) {
        alert("يرجى إدخال رقم الهوية أو الجوال");
        return;
      }

      const fullInput = input.startsWith("0") ? input : "0" + input;
      const altInput = input.startsWith("0") ? input.slice(1) : input;

      document.getElementById("loader").style.display = "block";

      // محاولة أولى: document ID
      let doc = await db.collection("kawadr").doc(fullInput).get();
      if (!doc.exists) {
        doc = await db.collection("kawadr").doc(altInput).get();
      }

      // محاولة ثانية: where("phone" == input)
      if (!doc.exists) {
        const querySnapshot = await db.collection("kawadr").where("phone", "==", Number(altInput)).get();
        if (!querySnapshot.empty) {
          doc = querySnapshot.docs[0];
        }
      }

      document.getElementById("loader").style.display = "none";

      if (!doc || !doc.exists) {
        alert("لم يتم العثور على بيانات.");
        return;
      }

      const data = doc.data();
      currentPhone = data.phone;
      currentId = data.id;

      document.getElementById("id").value = data.id || "";
      document.getElementById("full_name").value = `${data.name_ar || ""} ${data.father_ar || ""} ${data.family_ar || ""}`.trim();
      document.getElementById("birth_date_en").value = data.birth_date_en || "";

      const departmentField = document.getElementById("department");
      if (data.department && departmentField) {
        Array.from(departmentField.options).forEach(opt => {
          if (opt.value === data.department) {
            opt.selected = true;
          }
        });
      }

      document.getElementById("verifyBox").style.display = "none";
      document.getElementById("formBox").style.display = "block";
    }
    
  
  async function submitData() {
    const loader = document.getElementById("submitLoader");
    loader.style.display = "block";

    const birthDate = document.getElementById("birth_date_en").value.trim();
    
    const department = document.getElementById("department").value;
    if (!department) {
      loader.style.display = "none";
      alert("يرجى اختيار القسم قبل المتابعة");
      return;
    }
    const file = document.getElementById("pdfFile").files[0];
    
    
    const fullNameParts = document.getElementById("full_name").value.trim().split(" ");
const fullName = fullNameParts.slice(0, 3).join(" ").trim();
    
    const documentId = document.getElementById("phoneSearch").value.trim();

    if (!birthDate) {
      loader.style.display = "none";
      alert("يرجى إدخال تاريخ الميلاد");
      return;
    }

    if (!file) {
      loader.style.display = "none";
      alert("يرجى إرفاق ملف PDF قبل المتابعة");
      return;
    }

    try {
      console.log("⬅️ بدء تحديث تاريخ الميلاد...");
const targetDocId = currentPhone;
await db.collection("kawadr").doc(targetDocId).update({
        birth_date_en: birthDate,
        department: document.getElementById("department").value,
        last_updated: new Date().toISOString()
      });
      console.log("✅ تم تحديث تاريخ الميلاد");

      console.log("⬅️ تحويل الملف إلى base64...");
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];
        const formData = new FormData();
        formData.append("file", base64);
        formData.append("filename", fullName + " - " + documentId + ".pdf");

        console.log("⬅️ إرسال الملف إلى Google Drive Web App...");
        const response = await fetch("https://script.google.com/macros/s/AKfycbwVhO_q_6D5o3ukjD1k4SxELnJEitci0OslFgNdqU1KMV4S-a8WWgM3y2ifJ8Ey2jky/exec", {
          method: "POST",
          body: formData,
        });

        const text = await response.text();
        console.log("🔗 رد Google Apps Script:", text);

        if (text.startsWith("http")) {
const targetDocId = currentPhone;
await db.collection("kawadr").doc(targetDocId).update({
            pdf_url: text
          });
          console.log("✅ تم تحديث رابط الملف في Firestore");
        } else {
          alert("❌ فشل رفع الملف: " + text);
        }

        document.body.innerHTML = `
          <div style="text-align:center; padding: 40px;">
            <img src="logo.png" alt="شعار الشركة" style="height: 80px; margin-bottom: 20px;">
            <h2 style="color:#198754;">تم حفظ البيانات بنجاح</h2>
            <p>نسأل الله أن يوفقكم لخدمة ضيوف الرحمن.</p>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    } catch (error) {
      loader.style.display = "none";
      console.error("❌ خطأ أثناء إرسال البيانات:", error);
      
      let msg = error && error.message ? error.message : error.toString();
      alert("❌ حدث خطأ أثناء رفع البيانات:\n" + msg);
    
    }
  }



  
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø´Ø±ÙƒØ© Ø±ÙƒÙ† Ø§Ù„Ø­Ø·ÙŠÙ… Ù„Ù„Ø­Ø¬ - Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª PDF</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    * {
      font-family: 'Cairo', sans-serif;
    }
    body {
      background: #f0f2f5;
      direction: rtl;
      padding: 30px;
      max-width: 700px;
      margin: auto;
      text-align: right;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .form-box {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #198754;
      color: white;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #157347;
    }
    #loader {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .support-box {
      background: #fff;
      padding: 20px;
      border-top: 1px solid #ccc;
      border-radius: 0 0 10px 10px;
      text-align: center;
      font-size: 15px;
    }
    .support-box a {
      display: inline-block;
      padding: 10px 20px;
      background: #25D366;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="header">
  <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="height: 80px; margin-bottom: 10px;">
  <h2 style="color: #198754;">Ø´Ø±ÙƒØ© Ø±ÙƒÙ† Ø§Ù„Ø­Ø·ÙŠÙ… Ù„Ù„Ø­Ø¬</h2>
  <p>Ù†Ù…ÙˆØ°Ø¬  Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª - Ø­Ø¬   1446Ù‡Ù€</p>
</div>

<div class="form-box" id="verifyBox">
  <h3>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
  <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
  <input type="tel" id="phoneSearch" maxlength="10" inputmode="numeric">
  <button onclick="checkData()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  <div id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
</div>

<div class="form-box" id="formBox" style="display:none;">
  <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¯Ø±</h3>

  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</label>
  <input type="text" id="id" readonly style="background:#eee;">

  <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
  <input type="text" id="full_name" readonly style="background:#eee;">

  
    
    <label class="required">Ø§Ù„Ù‚Ø³Ù…:</label>
    <select id="department" class="form-control" style="margin-bottom: 15px;" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
      <option value="Ø§Ù„Ø´Ø±ÙƒØ©">Ø§Ù„Ø´Ø±ÙƒØ©</option>
      <option value="Ø§Ù„Ø¹Ù…Ø±Ø§Ù†">Ø§Ù„Ø¹Ù…Ø±Ø§Ù†</option>
      <option value="Ø§Ù„Ù…Ø¨Ø±Ø²">Ø§Ù„Ù…Ø¨Ø±Ø²</option>
      <option value="Ø§Ù„Ø´Ø¹Ø¨Ø©">Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
    </select>
    <label class="required">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙÙ‚Ø·):</label>
    
  <input type="date" id="birth_date_en" required>

  <label>Ù…Ù„Ù Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª (PDF):</label>
  <input type="file" id="pdfFile" accept="application/pdf">

  <div id="submitLoader" style="display:none; text-align:center; margin-top:15px;">
    <img src="https://i.imgur.com/llF5iyg.gif" alt="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" width="40"><br>
    Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
  </div>

  
  <button onclick="submitData()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>


<div class="support-box">
  <p>Ø¹Ù†Ø¯ Ù…ÙˆØ§Ø¬Ù‡ØªÙƒ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ø´Ø±ÙƒØ© Ø±ÙƒÙ† Ø§Ù„Ø­Ø·ÙŠÙ… Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨:</p>
  <a href="https://wa.me/966539617330" target="_blank">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
</div>

<script>
  // Firestore Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  const primaryApp = firebase.initializeApp({
    apiKey: "AIzaSyCjLt3g-2GPsMlxXPnzySXpCHl3-FyA80I",
    authDomain: "hajj2025-56177.firebaseapp.com",
    projectId: "hajj2025-56177"
  }, "Primary");

  const db = firebase.firestore(primaryApp);

  // Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø®Ø§Ø±Ø¬ÙŠ
  const storageApp = firebase.initializeApp({
    apiKey: "AIzaSyDHNEidF1ShWR7KDSN2GW34Qf6-s6ISvZQ",
    authDomain: "hajj2025-2.firebaseapp.com",
    projectId: "hajj2025-2",
    storageBucket: "hajj2025-2.appspot.com"
  }, "Storage");

  const storage = firebase.storage(storageApp);

  let currentPhone = "";
  let currentId = "";

  
    async function checkData() {
      const input = document.getElementById("phoneSearch").value.trim();
      if (!input) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„");
        return;
      }

      const fullInput = input.startsWith("0") ? input : "0" + input;
      const altInput = input.startsWith("0") ? input.slice(1) : input;

      document.getElementById("loader").style.display = "block";

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ù‰: document ID
      let doc = await db.collection("kawadr").doc(fullInput).get();
      if (!doc.exists) {
        doc = await db.collection("kawadr").doc(altInput).get();
      }

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ©: where("phone" == input)
      if (!doc.exists) {
        const querySnapshot = await db.collection("kawadr").where("phone", "==", Number(altInput)).get();
        if (!querySnapshot.empty) {
          doc = querySnapshot.docs[0];
        }
      }

      document.getElementById("loader").style.display = "none";

      if (!doc || !doc.exists) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
      }

      const data = doc.data();
      currentPhone = data.phone;
      currentId = data.id;

      document.getElementById("id").value = data.id || "";
      document.getElementById("full_name").value = `${data.name_ar || ""} ${data.father_ar || ""} ${data.family_ar || ""}`.trim();
      document.getElementById("birth_date_en").value = data.birth_date_en || "";

      const departmentField = document.getElementById("department");
      if (data.department && departmentField) {
        Array.from(departmentField.options).forEach(opt => {
          if (opt.value === data.department) {
            opt.selected = true;
          }
        });
      }

      document.getElementById("verifyBox").style.display = "none";
      document.getElementById("formBox").style.display = "block";
    }
    
  
  async function submitData() {
    const loader = document.getElementById("submitLoader");
    loader.style.display = "block";

    const birthDate = document.getElementById("birth_date_en").value.trim();
    
    const department = document.getElementById("department").value;
    if (!department) {
      loader.style.display = "none";
      alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
      return;
    }
    const file = document.getElementById("pdfFile").files[0];
    
    
    const fullNameParts = document.getElementById("full_name").value.trim().split(" ");
const fullName = fullNameParts.slice(0, 3).join(" ").trim();
    
    const documentId = document.getElementById("phoneSearch").value.trim();

    if (!birthDate) {
      loader.style.display = "none";
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
      return;
    }

    if (!file) {
      loader.style.display = "none";
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù PDF Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
      return;
    }

    try {
      console.log("â¬…ï¸ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯...");
const targetDocId = currentPhone;
await db.collection("kawadr").doc(targetDocId).update({
        birth_date_en: birthDate,
        department: document.getElementById("department").value,
        last_updated: new Date().toISOString()
      });
      console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");

      console.log("â¬…ï¸ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ base64...");
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];
        const formData = new FormData();
        formData.append("file", base64);
        formData.append("filename", fullName + " - " + documentId + ".pdf");

        console.log("â¬…ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Google Drive Web App...");
        const response = await fetch("https://script.google.com/macros/s/AKfycbwVhO_q_6D5o3ukjD1k4SxELnJEitci0OslFgNdqU1KMV4S-a8WWgM3y2ifJ8Ey2jky/exec", {
          method: "POST",
          body: formData,
        });

        const text = await response.text();
        console.log("ğŸ”— Ø±Ø¯ Google Apps Script:", text);

        if (text.startsWith("http")) {
const targetDocId = currentPhone;
await db.collection("kawadr").doc(targetDocId).update({
            pdf_url: text
          });
          console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù ÙÙŠ Firestore");
        } else {
          alert("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: " + text);
        }

        document.body.innerHTML = `
          <div style="text-align:center; padding: 40px;">
            <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="height: 80px; margin-bottom: 20px;">
            <h2 style="color:#198754;">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</h2>
            <p>Ù†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø£Ù† ÙŠÙˆÙÙ‚ÙƒÙ… Ù„Ø®Ø¯Ù…Ø© Ø¶ÙŠÙˆÙ Ø§Ù„Ø±Ø­Ù…Ù†.</p>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    } catch (error) {
      loader.style.display = "none";
      console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
      
      let msg = error && error.message ? error.message : error.toString();
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n" + msg);
    
    }
  }



  
</script>

</body>
</html>
